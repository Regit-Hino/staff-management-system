# スタッフ管理システム - プロジェクト情報

## バージョン情報
**Current Version: v2.4.0** (2025年6月17日)

### バージョン履歴
- **v1.0.0** (初期リリース) - スタッフ管理基本機能
- **v1.1.0** - モーダルシステム実装、編集機能追加
- **v1.2.0** - シフト管理画面実装
- **v2.0.0** - フィルター機能、デザイン統一、レスポンシブ対応
- **v2.1.0** - 左メニュー統一、CSS管理ルール確立、日・週・月表示対応
- **v2.2.0** - CSS設計根本改善、共通レイアウトファイル分離
- **v2.3.0** - 左メニュー統一問題の根本的修正（未完了）
- **v2.4.0** - 業務管理システム完全実装、ドラッグ&ドロップソート機能

### v2.4.0 新機能 (2025年6月17日) - 業務管理システム完全実装

#### 主要な新機能
1. **業務管理画面の完全実装**
   - 6つのタブ構成（業務、セクション、グループ、パターン、NGパターン、配置スタッフ表）
   - 業務作成モーダル（色選択、詳細設定、時間入力）
   - 業務一覧テーブル表示
   - 業務詳細モーダル（編集機能付き）

2. **業務作成・編集機能**
   - カラーピッカー付き色選択モーダル
   - 時間入力の自動正規化（シフト管理と同じロジック）
   - 割り当て方法・シフト種類の設定
   - スタッフ管理データとの連携

3. **ドラッグ&ドロップ並び替え機能**
   - 業務テーブルの行をドラッグ&ドロップで並び替え
   - スタッフ管理と同様の操作性
   - 順序変更の自動保存

4. **データ管理とUI統一**
   - localStorage による永続化
   - フォームバリデーション
   - UI統一（oplus準拠デザイン）
   - レスポンシブ対応

#### 技術的改善
- 変数名衝突バグの修正（saveBusiness関数）
- ドラッグ&ドロップのビジュアルフィードバック追加
- モーダル管理の改善
- エラーハンドリングの強化

### v2.3.0 継続作業 (2025年6月16日) - 左メニュー統一問題
#### 問題の現状
**重要：左メニューが全ページで統一されない問題が継続中**

#### 実施済み対策（効果なし）
1. **common-layout.css作成とインラインスタイル削除**
   - インラインの`<style>`タグを完全削除
   - CSS詳細度最大化（`body .container .sidebar`形式）
   - `!important`を多用した強制適用
   - バージョン更新（v=2.0.3）によるキャッシュクリア

2. **複数回の修正試行**
   - CSS継承構造の再設計
   - HTMLファイルのCSSロード順序変更
   - 共通レイアウト要素の一元管理

#### 技術的詳細
**CSS設計**:
```css
/* common-layout.css v2.0.3での詳細度最大化 */
body .container .sidebar {
    width: 180px !important;
    background: white !important;
    border-right: 1px solid #dee2e6 !important;
    padding: 0 !important;
    /* その他のプロパティも!important適用 */
}
```

**HTMLファイル構造**:
```html
<link rel="stylesheet" href="css/common-layout.css?v=2.0.3">
<link rel="stylesheet" href="css/[page-specific].css">
```

#### 根本原因の推定
1. **ブラウザキャッシュ問題** - バージョンクエリ使用でも解決せず
2. **CSS詳細度競合** - `!important`使用でも解決せず
3. **JavaScript動的スタイル適用** - 可能性あり（未確認）
4. **ブラウザ固有のレンダリング問題** - 可能性あり
5. **未発見のCSS定義** - 他ファイルでの重複定義の可能性

#### 次回作業のための指針
1. **ブラウザ開発者ツールでの詳細調査**
   - どのCSSルールが実際に適用されているか確認
   - Computed Stylesでの実際の値確認
   - Sources panelでCSSファイルの読み込み確認

2. **JavaScript干渉確認**
   - `staff-management.js`、`shift-management.js`でのスタイル操作確認
   - 動的クラス追加/削除の確認

3. **代替アプローチ検討**
   - CSSの完全リセットと再構築
   - インライン`style`属性の使用（最終手段）
   - CSS-in-JSアプローチの検討

#### ユーザーからのフィードバック
- 「治っていません」（v2.3.0時点）
- 左メニューがスタッフ管理とシフト管理で異なる表示
- 複数回の修正試行も効果なし

### v2.2.0 変更内容 (2025年6月16日) - 緊急修正（実行済み）
#### 根本的なCSS設計改善
1. **共通レイアウトファイルの新規作成**
   - `css/common-layout.css` 新規作成
   - ヘッダー、サイドバー、基本レイアウトを一元管理
   - 全ページで確実に同じスタイルが適用される構造

2. **CSS継承構造の完全な再設計**
   - 全HTMLファイルで`common-layout.css`を最初に読み込み
   - ページ固有CSSは純粋に追加機能のみ定義
   - 重複定義の完全排除

3. **各CSSファイルの役割明確化**
   - `common-layout.css`: 全ページ共通（ヘッダー、サイドバー、基本構造）
   - `staff-management.css`: スタッフ管理ページ固有機能のみ
   - `shift-management.css`: シフト管理ページ固有機能のみ
   - `staff-edit.css`: スタッフ編集ページ固有機能のみ

#### 技術的改善
- **列ずれ防止の最小限修正**（v2.1.0から継続）
  - 統一されたボーダー・パディング設定
  - レンダリング最適化の実装
- **システム設計の正常化**
  - 通常のシステム開発での標準的な構造に変更
  - メンテナンス性の向上

#### 変更ファイル
- **新規作成**: `css/common-layout.css` - 全ページ共通レイアウト
- **更新**: `index.html`, `shift-management.html`, `staff-edit.html` - CSS読み込み順序変更
- **リファクタ**: `css/staff-management.css` - 共通部分削除、ページ固有のみ保持
- **更新**: `css/shift-management.css` - メインコンテンツオーバーライド追加
- **更新**: `CLAUDE.md` - 新バージョン情報追加

#### 解決した問題
- 左メニューが各ページで異なって見える問題の根本解決
- CSS重複定義による予期しない表示の完全排除
- システム設計の正常化（業界標準に準拠）

#### 現在のデプロイ状況
- **ローカル**: v2.3.0 変更実施済み（効果なし） ❌
- **Git**: 未コミット ⚠️
- **本番**: 未デプロイ ⚠️
- **問題**: 左メニュー統一が未解決 🔴

## プロジェクト概要
oplus系のシフト管理システムのスタッフ管理機能を忠実に再現したWebアプリケーション。
TDD（Test-Driven Development）ベースでの開発を行い、UI/UXの完全な再現を目指している。

## 主要機能
### 実装済み機能
1. **スタッフ一覧表示**
   - ドラッグ&ドロップによる行の並び替え
   - 各スタッフの基本情報表示（名前、ふりがな、メモ、社員番号、タグ、時給、交通費、月最大出勤数、連絡先、権限、シフト表）
   - スタッフ数のカウント表示
   - 管理者権限者の視覚的識別（シアン色表示）

2. **スタッフ招待システム**
   - 7種類の招待方法（スタッフ登録、仮スタッフ登録、リンク、QRコード、CSVインポート、SMS、OCRダウンロード）
   - モーダルダイアログによる各招待方法の設定

3. **スタッフ編集機能**
   - 3点リーダーメニューからの編集・削除
   - スタッフ名クリックでの編集画面遷移
   - フルスクリーン編集画面（モーダルではない）
   - 個人情報と企業情報の2カラム編成
   - 詳細なフォームバリデーション
   - 権限管理（編集画面でのみ変更可能、一覧表示は読み取り専用）

4. **シフト管理システム**
   - 横長スクロール可能カレンダー
   - 日・週・月・カスタム表示切り替え（レスポンシブ対応）
   - 今日の日付の黄色い背景ハイライト表示
   - スタッフ管理データとの連携
   - カスタム期間選択モーダル（ドラッグ&ドロップ期間選択）
   - タブナビゲーション（シフト、業務、カウント、制出、労務）
   - 内部カレンダースクロール機能
   - 管理者権限者の視覚的識別（シアン色表示）

5. **フィルター機能**
   - フィルターモーダル（出勤者のみ・確定のみ）
   - 出勤者のみフィルター: 表示期間内にシフトがないスタッフを非表示
   - フィルター状態の保持とリアルタイム適用

6. **デザイン統一**
   - ゴシック体フォント（割当人数・人時・人件費・日付）
   - スタッフ管理とシフト管理画面間のデザイン統一
   - フォントサイズの統一（13px基準）

7. **データ永続化**
   - localStorage/sessionStorageを使用したクライアントサイド保存
   - スタッフ情報の編集・保存・読み込み

## ファイル構成
```
/Users/hinotakafumi/Desktop/claudecode/Oplusコピー/
├── index.html              # メインのスタッフ一覧画面
├── staff-edit.html         # スタッフ編集画面
├── shift-management.html   # シフト管理画面
├── css/
│   ├── staff-management.css  # メイン画面のスタイル
│   ├── staff-edit.css       # 編集画面専用スタイル
│   └── shift-management.css # シフト管理画面専用スタイル
├── js/
│   ├── staff-management.js  # メイン画面のJavaScript
│   ├── staff-edit.js        # 編集画面専用JavaScript
│   └── shift-management.js  # シフト管理画面専用JavaScript
├── test-action.html         # デバッグ用テストページ
└── CLAUDE.md               # このファイル
```

## 技術仕様
- **HTML5** with semantic structure
- **CSS3** with Flexbox/Grid layouts
- **Vanilla JavaScript** (フレームワーク不使用)
- **FontAwesome 6.0.0** for icons
- **localStorage/sessionStorage** for data persistence

## データ構造
### スタッフデータ (localStorage: 'staffManagementData')
```javascript
{
  id: string,
  name: string,
  furigana: string,
  email: string,
  phone: string,
  role: string, // '管理者'|'スタッフ'|'シフト編集者'|'閲覧者'
  isTemp: boolean,
  employeeId: string,
  hourlyWage: string,
  transport: string,
  maxMonthly: string,
  monthlyBreak: string,
  weekMin: string,
  weekMax: string,
  monthMin: string,
  monthMax: string,
  joinYear: string,
  joinMonth: string,
  joinDay: string,
  weeklyDays: string,
  connectionId: string,
  memo: string,
  tag: string,
  applyAll: boolean
}
```

### 編集用データ (localStorage: 'allStaffData')
```javascript
{
  [staffId]: staffData,
  ...
}
```

### 編集中スタッフID (sessionStorage: 'editingStaffId')
```javascript
string // スタッフのID
```

### フィルター状態（グローバル変数）
```javascript
let attendeeOnlyFilter = false; // 出勤者のみフィルター
let confirmedOnlyFilter = false; // 確定のみフィルター（未実装）
```

### シフトデータ（サンプル）
```javascript
// 特定日のシフト有無判定
const shiftData = {
  '日野 真文': [{ date: '6/2', day: 1 }], // 月曜日
  'Regit 高木': [{ date: '6/3', day: 2 }], // 火曜日
  '上原': [{ date: '6/2', day: 1 }], // 月曜日
  // タロウ、一雄: シフトなし
};
```

## UI/UX設計方針
1. **oplus完全準拠** - 提供されたスクリーンショットに基づく忠実な再現
2. **レスポンシブ対応** - モバイル・タブレット・デスクトップでの適切な表示
3. **直感的操作** - ドラッグ&ドロップ、モーダル、ドロップダウンによる操作性
4. **一貫性のあるデザイン** - カラーパレット、フォント、余白の統一

## 重要な実装ポイント
### レイアウト統一ルール（全画面共通）
- **CSS継承ルール**
  - 全ページでstaff-management.cssを最初にインポート（共通レイアウト）
  - 各ページ専用CSSは追加スタイルのみ定義（重複定義禁止）
  - HTMLの<link>タグ順序: staff-management.css → ページ専用CSS
- **左サイドバー**は全画面で統一デザインを使用
  - 幅: 180px（固定）
  - 背景: white
  - ボーダー: 右側に1px solid #dee2e6
  - ナビゲーションアイテムは共通スタイル（アクティブ状態、ホバー効果含む）
  - アップグレードボタンは最下部に配置
- **ヘッダー**は全画面で統一
  - 高さ: 52px
  - 会社選択、ロゴ、通知、ユーザー名の配置
- **メインコンテンツ**は左サイドバー分を除いた残りの幅を使用
  - flex: 1で自動調整
  - padding: 16px 20px
  - 背景: #f8f9fa
- **内部スクロール**はコンテンツが画面幅を超える場合に実装

### CSS管理重要注意事項 ⚠️ 要改善
1. **共通レイアウト要素の重複定義は絶対禁止**
   - .header, .sidebar, .nav-item, .container等
   - common-layout.cssで定義済みのクラスは再定義しない
2. **各ページ専用CSSファイルの役割**
   - ページ固有の機能・コンポーネントのみ定義
   - 例: .tab-navigation, .shift-table等
3. **デバッグ時の確認項目**
   - CSSの詳細度による上書きが発生していないか
   - HTMLでのCSS読み込み順序が正しいか
   - ブラウザ開発者ツールでの実際の適用ルール確認
   - JavaScriptによる動的スタイル変更の確認

### 左メニュー統一問題の緊急対応手順
**次回セッション開始時に必ず実行すること：**

1. **開発者ツールでの詳細調査**
   ```
   - Chromeで両ページを開く
   - F12 → Elements → .sidebar要素を選択
   - Computed Styles で実際の適用値を確認
   - Styles で競合するルールを特定
   ```

2. **実際の表示の比較**
   - index.html（スタッフ管理）の左メニュー
   - shift-management.html（シフト管理）の左メニュー
   - 具体的な違いを特定（幅、色、パディング、ボーダー等）

3. **JavaScript干渉確認**
   ```javascript
   // 各JSファイルでサイドバーに対する操作を検索
   // classList.add, classList.remove, style属性変更等
   ```

4. **最終手段の検討**
   - 全CSSファイルの完全リセット
   - HTMLファイルでの直接`style`属性指定
   - 問題の根本原因特定まで一時的な対処療法

### イベント管理
- **イベント委譲**を使用した3点リーダーボタンの管理
- 重複イベントリスナーの防止
- DOMの動的変更に対応した確実なイベント設定
- フィルターボタンの直接設定による確実な動作保証

### データ同期
- 編集画面と一覧画面間での確実なデータ同期
- localStorage/sessionStorageの適切な使い分け
- データ更新後のUI反映
- フィルター適用時のスタッフリストとカレンダーの同期更新

### レスポンシブデザイン
- 日・週・月表示に応じたカレンダー列幅の動的変更
- 内部スクロール機能による適切な画面サイズ制御
- フォントサイズ統一によるデザイン一貫性
- 左サイドバー固定幅での画面サイズ対応

### シフト管理画面専用機能
- **表示切り替え**（日・週・月・カスタム）による期間変更と表示列数調整
- **フィルター機能**（出勤者のみ・確定のみ）
- **カレンダー横スクロール**による月全体表示
- **期間ナビゲーション**（前後移動、今日ボタン）

### モーダル管理
- 複数モーダル（カスタム期間選択・フィルター）の適切な制御
- 背景クリック・×ボタンでの閉じる機能
- フィルター状態の保持と復元

### エラーハンドリング
- フォームバリデーション（必須項目、時間形式、日付妥当性）
- データ保存失敗時の適切なエラーメッセージ
- コンソールログによるデバッグ情報
- /ultrathinkによる根本原因分析

## 既知の問題・改善点
### 🔴 クリティカル問題（最優先）
1. **左メニュー統一問題** - 複数回の修正試行も効果なし、根本原因不明
   - index.html とshift-management.html で左サイドバーの表示が異なる
   - CSS詳細度最大化、!important使用でも解決せず
   - 次回セッションで開発者ツールによる詳細調査が必要

### ⚠️ 機能未実装（低優先）
2. **確定のみフィルター** - フィルターモーダル内に項目はあるが機能未実装
3. **シフトデータ拡張** - 現在はハードコードされたサンプルデータのみ
4. **シフト編集機能** - シフトセルのクリック編集機能が未実装
5. **実際のシフト管理** - シフトの追加・編集・削除機能が未実装

## 開発履歴
- 初期実装: HTML/CSS/JavaScriptによる基本機能
- モーダル実装: 7種類の招待方法対応
- 編集機能: フルスクリーン編集画面とデータ永続化
- イベント修正: 委譲方式による確実な3点リーダー動作
- UI改善: oplus準拠のデザイン調整
- シフト管理画面: カレンダー表示とタブナビゲーション実装
- レスポンシブ対応: 日・週・月表示の動的サイズ調整
- デザイン統一: ゴシック体フォント、フォントサイズ統一、管理者色分け
- フィルター機能: 出勤者のみフィルターとモーダル実装
- /ultrathink導入: 根本原因分析による確実な問題解決

## テスト方法
### スタッフ管理画面 (index.html)
1. ブラウザでindex.htmlを開く
2. F12でデベロッパーツールを開き、コンソールでログを確認
3. 各機能の動作確認:
   - スタッフ一覧の表示（管理者のシアン色表示確認）
   - ドラッグ&ドロップ
   - 追加ボタンのドロップダウン
   - 3点リーダーメニュー
   - 編集画面への遷移と保存
   - データの永続化確認

### シフト管理画面 (shift-management.html)
1. ブラウザでshift-management.htmlを開く
2. 各機能の動作確認:
   - カレンダー表示（今日の日付ハイライト確認）
   - 日・週・月表示切り替え（列幅変更確認）
   - フィルターボタンクリック → モーダル表示
   - 出勤者のみフィルター適用 → スタッフ数減少確認
   - カスタム期間選択モーダル
   - 内部スクロール機能
   - スタッフ管理との連携確認

### フィルター機能テスト
1. シフト管理画面でフィルターボタン（🔽）をクリック
2. 「出勤者のみ」チェック → 適用
3. スタッフリストが5名 → 3名に減少することを確認
4. カレンダーも対応するスタッフのみ表示されることを確認

## 注意事項
- 実際の動作確認を必ず行ってから修正完了を報告すること
- ユーザーからの「治っていない」指摘があった場合は、必ず実際のテストを実施
- /ultrathink で根本原因を特定してから修正に取り組む
- デバッグログを活用した問題特定を行う

## 🚨 緊急事項：左メニュー統一問題
**v2.3.0時点でユーザーから「治っていません」の確認あり**

### 次回セッション時の必須作業
1. ブラウザ開発者ツールでの詳細調査実行
2. 実際の表示差異の具体的特定
3. JavaScript干渉の有無確認
4. 根本原因特定まで一時的対処療法の検討

### 修正効果のなかった手法（再試行不要）
- CSS詳細度最大化（`body .container .sidebar`）
- `!important`の多用
- インラインスタイルの削除
- バージョンクエリによるキャッシュクリア（`?v=2.0.3`）
- common-layout.cssの新規作成と一元管理